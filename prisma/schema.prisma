generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  ownerPhone String?
  points    Int      @default(0)
  createdAt DateTime @default(now())

  buses           Bus[]
  routes          Route[]
  students        Student[]
  trips           Trip[]
  drivers         Driver[]
  pointTx         PointTransaction[]
  notificationLog NotificationLog[]
  shareTokens     ShareToken[]
  driverConsents  DriverConsent[]
}

model Bus {
  id             Int      @id @default(autoincrement())
  organizationId Int
  name           String
  plateNumber    String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  routes       Route[]
  trips        Trip[]
}

enum DriverStatus {
  PENDING
  ACTIVE
  REVOKED
}

model Driver {
  id             Int      @id @default(autoincrement())
  organizationId Int
  name           String
  phone          String
  status         DriverStatus @default(PENDING)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  routes       Route[]
  shareTokens  ShareToken[]
  consents     DriverConsent[]

  @@index([organizationId])
}

model Route {
  id             Int      @id @default(autoincrement())
  organizationId Int
  busId          Int?
  driverId       Int?
  name           String
  alertBeforeCnt Int      @default(2)
  createdAt      DateTime @default(now())

  organization   Organization    @relation(fields: [organizationId], references: [id])
  bus            Bus?            @relation(fields: [busId], references: [id])
  driver         Driver?         @relation(fields: [driverId], references: [id])

  stops          Stop[]
  boardingLogs   BoardingLog[]
  driverLocation DriverLocation?
  trips          Trip[]
  shareTokens    ShareToken[]

  @@index([organizationId])
  @@index([busId])
  @@index([driverId])
}

model Stop {
  id        Int      @id @default(autoincrement())
  routeId   Int
  name      String
  address   String?
  latitude  Float
  longitude Float
  orderNo   Int
  createdAt DateTime @default(now())

  route        Route         @relation(fields: [routeId], references: [id])
  students     Student[]
  boardingLogs BoardingLog[]
  trips        Trip[]
  stopEvents   StopEvent[]

  @@index([routeId, orderNo])
}

model Student {
  id             Int      @id @default(autoincrement())
  organizationId Int
  stopId         Int?
  name           String
  parentPhone    String
  createdAt      DateTime @default(now())

  organization Organization  @relation(fields: [organizationId], references: [id])
  stop         Stop?         @relation(fields: [stopId], references: [id])
  boardings    BoardingLog[]

  @@index([organizationId])
  @@index([stopId])
}

enum BoardingStatus {
  BOARDED
  NOT_BOARDED
  SKIPPED
}

enum BoardingMode {
  MANUAL
  AUTO
}

model BoardingLog {
  id        Int            @id @default(autoincrement())
  studentId Int
  routeId   Int
  stopId    Int
  tripId    Int?
  status    BoardingStatus
  mode      BoardingMode   @default(MANUAL)
  createdAt DateTime       @default(now())

  student Student @relation(fields: [studentId], references: [id])
  route   Route   @relation(fields: [routeId], references: [id])
  stop    Stop    @relation(fields: [stopId], references: [id])
  trip    Trip?   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([routeId, createdAt])
  @@index([tripId, stopId, createdAt])
  @@index([studentId, tripId])
}

enum NotificationType {
  BEFORE_STOP
  ARRIVED
  MANUAL
  DRIVER_SHARE_DISABLED
}

enum NotificationChannel {
  ALIMTALK
  SMS
}

model NotificationLog {
  id             Int                  @id @default(autoincrement())
  organizationId Int?
  routeId        Int?
  stopId         Int?
  phone          String
  message        String
  type           NotificationType
  channel        NotificationChannel?
  costPoints     Int                  @default(0)
  createdAt      DateTime             @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id])

  @@index([organizationId, createdAt])
  @@index([phone, createdAt])
}

model DriverLocation {
  id        Int      @id @default(autoincrement())
  routeId   Int      @unique
  latitude  Float
  longitude Float
  updatedAt DateTime @updatedAt

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)
}

enum TripType {
  PICKUP
  DROPOFF
}

enum TripStatus {
  RUNNING
  ENDED
}

enum StopEventType {
  ARRIVE
  DEPART
}

model Trip {
  id             Int        @id @default(autoincrement())
  organizationId Int
  routeId        Int
  busId          Int?
  type           TripType
  status         TripStatus @default(RUNNING)
  startedAt      DateTime   @default(now())
  endedAt        DateTime?
  currentStopId  Int?
  createdAt      DateTime   @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  route        Route        @relation(fields: [routeId], references: [id], onDelete: Cascade)
  bus          Bus?         @relation(fields: [busId], references: [id])
  currentStop  Stop?        @relation(fields: [currentStopId], references: [id])

  stopEvents   StopEvent[]
  boardingLogs BoardingLog[]

  @@index([routeId, status, startedAt])
}

model StopEvent {
  id        Int           @id @default(autoincrement())
  tripId    Int
  stopId    Int
  type      StopEventType
  createdAt DateTime      @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  stop Stop @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@unique([tripId, stopId, type])
  @@index([tripId, createdAt])
}

model ShareToken {
  token          String   @id
  organizationId Int
  routeId        Int
  driverId       Int?
  createdAt      DateTime @default(now())
  expiresAt      DateTime

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  route        Route        @relation(fields: [routeId], references: [id], onDelete: Cascade)
  driver       Driver?      @relation(fields: [driverId], references: [id])

  @@index([routeId, expiresAt])
  @@index([organizationId, expiresAt])
}

model PointTransaction {
  id             Int      @id @default(autoincrement())
  organizationId Int
  amount         Int
  balanceAfter   Int
  reason         String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
}

enum DriverConsentStatus {
  PENDING
  ACCEPTED
  REVOKED
}

model DriverConsent {
  token          String             @id
  organizationId Int
  driverId       Int
  status         DriverConsentStatus @default(PENDING)
  createdAt      DateTime           @default(now())
  expiresAt      DateTime
  consentedAt    DateTime?
  revokedAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  driver       Driver       @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([driverId, createdAt])
}
